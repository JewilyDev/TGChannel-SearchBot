# Стек технологий бота

## Основные технологии

### 1. Фреймворки и библиотеки
- **Aiogram** (v3.x) - основной фреймворк для работы с Telegram API
  - Включает: `Bot`, `Dispatcher`, `Router`, `FSM`
  - Использует: `MemoryStorage` для хранения состояний
- **Asyncio** - для асинхронного выполнения операций


### 2. Работа с данными
- **PostgreSQL** (через asyncpg/aiopg) - основное хранилище данных
- **Текстовые индексы** - собственная реализация поиска по текстам
- **JSON** - обработка конфигов и данных API

### 3. Внешние интеграции
- **Telegram Bot API** - через aiogram


### 4. Вспомогательные системы
- **Конфигурация** - кастомный `config_manager`
- **Логирование** - кастомный `main_logger`
- **Парсинг** - собственная система `tg_parser`

## Архитектурные особенности

### 1. `create_bot.py`
**Назначение**: Инициализация основного объекта бота и диспетчера.

**Функционал**:
- Получает конфигурацию бота и Telegram API
- Создает объект бота с HTML-парсингом сообщений
- Инициализирует диспетчер с хранилищем в памяти
- Проверяет наличие обязательных конфигов перед созданием

**Важно**:
- Без корректных конфигов бот не будет создан
- Использует `MemoryStorage` для хранения состояний

### 2. `run.py`
**Назначение**: Главный исполнительный файл бота.

**Функционал**:
- Подключает роутер обработчиков из `handlers/init.py`
- Удаляет вебхук перед запуском
- Создает пул соединений с базой данных
- Запускает long-polling бота
- Логирует успешный старт системы

**Особенности**:
- Использует асинхронный запуск через `asyncio.run()`
- Первым делом очищает pending updates

### 3. `handlers/init.py`
**Назначение**: Основной обработчик команд и сообщений.

**Ключевые компоненты**:

#### Команды:
- `/start` - приветствие и регистрация пользователя
- `/stop` - аварийное завершение работы
- `/settings` - меню настроек
- `/index_build` - перестроение поисковых индексов
- `/parse` - полный парсинг источников и пересоздание БД
- `/generate` - генерация вопросов (вспомогательная)
- `/release` - поиск релизов

#### Основные обработчики:
- `prompt_answer()` - обработка пользовательских запросов:
  - Поиск по текстовым индексам
  - Формирование ответа
  - Логирование взаимодействий
- Обработка feedback (лайки/дислайки)
- Машина состояний для настроек

#### Особенности:
- Интеграция с внешними сервисами (LLM, парсер)
- Работа с текстовыми индексами
- Система фидбэка для ответов
- Гибкая система настроек пользователя

## Взаимодействие компонентов

1. `create_bot.py` создает ядро бота
2. `run.py` запускает систему, подключая обработчики
3. `init.py` обрабатывает все входящие взаимодействия
4. Все компоненты используют общую конфигурацию через `config_manager`

## Запуск системы
Заходим в основной venv:
1. cd /home/znai/
2. source venv/bin/activate

Затем устанавливаем стартовую директорию для исполнения всех python-скриптов
export PYTHONPATH=/home/znai/tgbot/tgbotsb/

Затем заходим в домашнюю папку бота
cd /home/znai/tgbot/tgbotsb/
Заходим в телеграмную часть
cd telegram_bot/src
Запускаем бота python run.py

